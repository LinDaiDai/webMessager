"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_uuid=_interopRequireDefault(require("uuid")),_lodash=require("lodash"),_logger=_interopRequireDefault(require("./logger"));function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);r&&(s=s.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,s)}return t}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach((function(r){(0,_defineProperty2.default)(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}var WebService=function(){function e(r){(0,_classCallCheck2.default)(this,e),(0,_defineProperty2.default)(this,"messager",void 0),(0,_defineProperty2.default)(this,"listeners",new Map),(0,_defineProperty2.default)(this,"retryQueue",[]),(0,_defineProperty2.default)(this,"namespace",void 0),(0,_defineProperty2.default)(this,"logger",void 0);var t=r.messager,s=r.log,a=r.namespace;this.namespace=a,this.logger=new _logger.default(s,this.namespace),this.initMessager(t)}return(0,_createClass2.default)(e,[{key:"initMessager",value:function(e){var r=this;this.messager=e,this.messager.onReceiveMessage(this.handleReceiveMessage.bind(this)),this.messager.onready=function(){r.startRetryRequest()}}},{key:"startRetryRequest",value:function(){var e=this,r=this.retryQueue.slice();this.retryQueue=[],r.forEach((function(r){e.send(r)}))}},{key:"handleReceiveMessage",value:function(e){var r=this,t=e.type,s=e.headers;this.logger.logMessage("receive message",e);var a=this.listeners[t];if(a){var i=s.reqId,n=_objectSpread(_objectSpread({},e),{},{end:function(e){(0,_lodash.merge)(e,{headers:{reqId:i},type:t}),r.send(e)}});this._handleOnceListeners(a,n),this._handleNormalListeners(a,n)}}},{key:"_handleOnceListeners",value:function(e,r){var t=r.headers,s=r.data,a=t.reqId;(0,_lodash.remove)(e,(function(e){var r=e.reqId&&e.reqId===a||!e.reqId;return e.once&&r})).forEach((function(e){e.callback&&e.callback(s,r)}))}},{key:"_handleNormalListeners",value:function(e,r){var t=r.headers,s=r.data,a=t.reqId;e.forEach((function(e){e.reqId?e.reqId===a&&e.callback&&e.callback(s,r):e.callback&&e.callback(s,r)}))}},{key:"send",value:function(e,r){var t={type:"",headers:{reqId:(0,_uuid.default)(),mMode:"push"},data:{}};if("string"==typeof e?(0,_lodash.merge)(t,{type:e,data:{body:r}}):(0,_lodash.merge)(t,e),t.type){if(this.messager.sendAction(t)){var s=globalThis.onWebServiceExecOperation;s&&s(this,"sendAction",t),this.logger.logMessage("send message",t)}else this.retryQueue.push(t),this.logger.logMessage("receiver is not ready, request will wait and resend",t);return t}console.error("[webService]message type for sending is not supplied")}},{key:"request",value:function(e,r){var t=this;return new Promise((function(s,a){var i;(i="string"==typeof e?{type:e,data:{body:r}}:e).headers=_objectSpread(_objectSpread({},i.headers),{},{mMode:"request"});var n=t.send(i);t.on(i.type,{callback:function(e){s(e)},reqId:n.headers.reqId,once:!0})}))}},{key:"on",value:function(e,r){var t,s=this;this.listeners[e]||(this.listeners[e]=[]),t="function"==typeof r?{callback:r,reqId:"",once:!1}:r,this.listeners[e].push(t);var a=globalThis.onWebServiceExecOperation;a&&a(this,"addListener",{type:e,messageListener:t});return function(){s.off(e,t)}}},{key:"off",value:function(e,r){if(r){var t;if("function"==typeof r)(0,_lodash.remove)(this.listeners[e],(function(e){return e.callback===r})),t={callback:r};else{var s=r.callback,a=r.reqId;(0,_lodash.remove)(this.listeners[e],(function(e){return e.callback===s||e.reqId&&e.reqId===a})),t=r}0===this.listeners[e].length&&delete this.listeners[e];var i=globalThis.onWebServiceExecOperation;i&&i(this,"removeListener",{type:e,messageListener:t})}else delete this.listeners[e]}},{key:"removeAllListeners",value:function(){this.listeners=new Map;var e=globalThis.onWebServiceExecOperation;e&&e(this,"removeAllListener")}}]),e}(),_default=WebService;exports.default=_default;